<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Wrapz | RAMS Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* --- PROFESSIONAL DARK THEME --- */
        :root {
            --brand-primary: #222222; /* Jet Black / Dark Charcoal */
            --brand-secondary: #444444;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-main: #333333;
            --border-color: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 15px;
            padding-bottom: 50px;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            color: var(--brand-primary);
            font-size: 1.8rem;
            margin-bottom: 5px;
            text-align: center;
            letter-spacing: -0.5px;
            text-transform: uppercase;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 25px;
        }

        h2 {
            font-size: 1.1rem;
            color: #444;
            border-left: 5px solid var(--brand-primary);
            padding-left: 12px;
            margin-top: 30px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Card Styling */
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 15px;
            border: 1px solid #eee;
        }

        label {
            display: block;
            font-weight: 700;
            font-size: 0.85rem;
            margin-bottom: 8px;
            color: #555;
            text-transform: uppercase;
        }

        input[type="text"], input[type="date"], textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
            background: #fafafa;
            -webkit-appearance: none;
            color: #333;
        }

        input:focus, textarea:focus, select:focus {
            border-color: var(--brand-primary);
            background: #fff;
            outline: none;
        }

        textarea {
            min-height: 100px;
            line-height: 1.4;
            resize: vertical;
        }

        /* Risk Cards */
        .risk-card {
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .risk-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .risk-checkbox {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            accent-color: var(--brand-primary);
            cursor: pointer;
        }

        .risk-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--brand-primary);
        }

        .risk-hazard {
            font-size: 0.85rem;
            color: #666;
            font-style: italic;
            margin-bottom: 12px;
        }

        .score-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .score-box {
            background: #f4f4f4;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .score-label {
            display: block;
            font-size: 0.7rem;
            color: #777;
            margin-bottom: 4px;
            font-weight: bold;
        }

        .fixed-score {
            font-weight: bold;
            font-size: 1rem;
            color: #222;
        }

        /* SIGNATURE CANVAS STYLES */
        .signature-pad {
            border: 2px dashed #ccc;
            border-radius: 8px;
            width: 100%;
            height: 180px;
            background: #fff;
            touch-action: none; /* Prevents scrolling while signing */
        }
        .clear-btn {
            background: #eee;
            color: #555;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-top: 5px;
            cursor: pointer;
        }

        /* Main Button */
        .generate-btn {
            background-color: var(--brand-primary);
            color: white;
            width: 100%;
            padding: 18px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            margin-top: 30px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .generate-btn:active {
            transform: translateY(2px);
            background-color: black;
        }

    </style>
</head>
<body>

<div class="app-container">
    
    <h1>Elite Wrapz</h1>
    <p class="subtitle">RAMS Generator & Sign Off</p>

    <h2>1. Job Details</h2>
    <div class="card">
        <div style="margin-bottom: 15px;">
            <label>Client Name</label>
            <input type="text" id="clientName" placeholder="e.g. Site Manager">
        </div>
        <div style="margin-bottom: 15px;">
            <label>Project Ref</label>
            <input type="text" id="projectRef" placeholder="e.g. EW-001">
        </div>
        <div style="margin-bottom: 15px;">
            <label>Site Address</label>
            <input type="text" id="siteAddress" placeholder="e.g. 12 High Street">
        </div>
        <div>
            <label>Date</label>
            <input type="date" id="assessmentDate">
        </div>
    </div>

    <h2>2. Method Statement</h2>
    <div class="card">
        <label>Sequence of Work</label>
        <textarea id="methodStatement">1. Arrival: Sign in. Inspect area.
2. Setup: Cordon off workspace. Protect floors.
3. Prep: Clean surfaces with IPA. Ensure ventilation.
4. Install: Apply vinyl using knifeless tape.
5. Finish: Post-heat edges. Quality check.
6. Clear: Remove waste/sharps. Handover.</textarea>
    </div>

    <h2>3. Risk Assessment</h2>
    <div id="riskList"></div>

    <h2>4. Sign Off</h2>
    <div class="card">
        <div style="margin-bottom: 20px;">
            <input type="checkbox" id="coshhCheck" checked style="transform: scale(1.3); margin-right: 10px;">
            <span style="font-size: 0.9rem; font-weight: 600; color: #444;">COSHH: SDS available for solvents.</span>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label>Assessor Name</label>
            <input type="text" id="assessorName" value="Richard Yates">
        </div>

        <label>Signature (Sign Below)</label>
        <canvas id="sigCanvas" class="signature-pad"></canvas>
        <button class="clear-btn" onclick="clearSignature()">Clear Signature</button>
    </div>

    <button class="generate-btn" onclick="generatePDF()">Generate & Sign PDF</button>

</div>

<script>
    // --- 1. SETUP DATE ---
    document.getElementById('assessmentDate').valueAsDate = new Date();

    // --- 2. SIGNATURE PAD LOGIC ---
    const canvas = document.getElementById('sigCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    // Resize canvas for better resolution
    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        ctx.scale(ratio, ratio);
    }
    window.addEventListener("resize", resizeCanvas);
    setTimeout(resizeCanvas, 100); // Initial resize

    // Draw functions
    function startDraw(e) {
        isDrawing = true;
        ctx.beginPath();
        const { x, y } = getPos(e);
        ctx.moveTo(x, y);
    }
    function draw(e) {
        if (!isDrawing) return;
        e.preventDefault(); // Stop scrolling while drawing
        const { x, y } = getPos(e);
        ctx.lineTo(x, y);
        ctx.strokeStyle = "#000";
        ctx.lineWidth = 2;
        ctx.lineCap = "round";
        ctx.stroke();
    }
    function stopDraw() { isDrawing = false; }
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    // Event Listeners (Touch & Mouse)
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDraw);
    canvas.addEventListener('touchstart', startDraw, {passive: false});
    canvas.addEventListener('touchmove', draw, {passive: false});
    canvas.addEventListener('touchend', stopDraw);

    function clearSignature() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // --- 3. RISK DATA ---
    const risks = [
        { title: "Damage to Property", hazard: "Cuts to surfaces, Heat damage", fixedS: 3, mitigation: "Strict use of cutting mats. Knifeless tape used for surface cuts. Low-tack masking tape used." },
        { title: "Public Safety", hazard: "Injury to third parties", fixedS: 3, mitigation: "Work area cordoned off. Blades never left unattended. Chemicals stored securely." },
        { title: "Electrical Fixtures", hazard: "Electric shock from sockets", fixedS: 3, mitigation: "Visual check. Non-conductive tools. Power isolated if faceplates removed." },
        { title: "Site Access / Loading", hazard: "Collision, Blocking Exits", fixedS: 2, mitigation: "Park in designated bay. Hazard lights on. Walkways kept clear." },
        { title: "Heat Guns", hazard: "Fire risk, Burns", fixedS: 2, mitigation: "Heat gun on stand (never on carpet). Fire extinguisher nearby." },
        { title: "Sharp Tools", hazard: "Cuts/Lacerations", fixedS: 2, mitigation: "Retractable blades only. Sharps bin used. Snap-off away from body." },
        { title: "Solvents (COSHH)", hazard: "Fumes, Skin irritation", fixedS: 1, mitigation: "Ventilation ensured. Nitrile gloves worn. Minimal quantities used." }
    ];

    // Render Risks
    const riskContainer = document.getElementById('riskList');
    risks.forEach((risk, index) => {
        const card = document.createElement('div');
        card.className = 'risk-card';
        card.innerHTML = `
            <div class="risk-header">
                <input type="checkbox" class="risk-checkbox" id="risk-${index}" checked>
                <div class="risk-title">${risk.title}</div>
            </div>
            <div class="risk-hazard">${risk.hazard}</div>
            <div style="margin-bottom:10px;">
                <label style="font-size:0.7rem;">Control Measures</label>
                <textarea id="mitigation-${index}" style="min-height:60px; font-size:0.9rem;">${risk.mitigation}</textarea>
            </div>
            <div class="score-grid">
                <div class="score-box"><span class="score-label">SEVERITY (Fixed)</span><div class="fixed-score">${risk.fixedS}</div></div>
                <div class="score-box"><span class="score-label">LIKELIHOOD</span>
                    <select id="L-${index}" style="font-weight:bold; padding:5px;">
                        <option value="1">1 (Low)</option>
                        <option value="2">2 (Med)</option>
                        <option value="3">3 (High)</option>
                    </select>
                </div>
            </div>`;
        riskContainer.appendChild(card);
    });

    // --- 4. PDF GENERATION ---
    async function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // COLORS (Grey/Black Theme)
        const primaryColor = [40, 40, 40]; // Dark Grey
        const accentColor = [220, 220, 220]; // Light Grey

        // HEADER
        doc.setFontSize(22); doc.setTextColor(...primaryColor); doc.setFont(undefined, 'bold');
        doc.text("ELITE WRAPZ", 14, 20);
        doc.setFontSize(10); doc.setTextColor(80);
        doc.text("RAMS | Risk Assessment & Method Statement", 14, 26);
        doc.setFontSize(9); doc.setFont(undefined, 'normal');
        doc.text("87 Parkhouse Drive, Birmingham, West Midlands", 14, 35);
        doc.text("07424 088434 | contact@elitewrapz.uk", 14, 40);

        // JOB DETAILS
        doc.autoTable({
            startY: 45,
            head: [['PROJECT DETAILS', '']],
            body: [
                ['Client Name', document.getElementById('clientName').value],
                ['Project Ref', document.getElementById('projectRef').value],
                ['Site Address', document.getElementById('siteAddress').value],
                ['Date', document.getElementById('assessmentDate').value]
            ],
            theme: 'grid',
            headStyles: { fillColor: primaryColor, textColor: 255, fontStyle: 'bold' },
            columnStyles: { 0: { fontStyle: 'bold', width: 40, fillColor: [245, 245, 245] } }
        });

        // METHOD STATEMENT
        doc.setFontSize(11); doc.setTextColor(...primaryColor); doc.setFont(undefined, 'bold');
        doc.text("1. METHOD STATEMENT", 14, doc.lastAutoTable.finalY + 15);
        
        doc.setFontSize(10); doc.setTextColor(0); doc.setFont(undefined, 'normal');
        const methodText = document.getElementById('methodStatement').value;
        const splitMethod = doc.splitTextToSize(methodText, 180);
        const boxHeight = (splitMethod.length * 5) + 6;
        doc.setFillColor(250, 250, 250); doc.setDrawColor(200, 200, 200);
        doc.rect(14, doc.lastAutoTable.finalY + 18, 182, boxHeight, 'FD');
        doc.text(splitMethod, 17, doc.lastAutoTable.finalY + 23);

        let currentY = doc.lastAutoTable.finalY + 25 + boxHeight;

        // RISKS
        doc.setFontSize(11); doc.setTextColor(...primaryColor); doc.setFont(undefined, 'bold');
        doc.text("2. RISK ASSESSMENT", 14, currentY);

        let riskBody = [];
        risks.forEach((risk, index) => {
            if (document.getElementById(`risk-${index}`).checked) {
                const mit = document.getElementById(`mitigation-${index}`).value;
                const L = parseInt(document.getElementById(`L-${index}`).value);
                const S = risk.fixedS;
                const score = L * S;
                let rating = "LOW (" + score + ")";
                if(score >= 3) rating = "MED (" + score + ")";
                if(score >= 6) rating = "HIGH (" + score + ")";

                riskBody.push({ content: [risk.title + "\n(" + risk.hazard + ")", L, S, rating, mit], rawScore: score });
            }
        });

        doc.autoTable({
            startY: currentY + 5,
            head: [['HAZARD / ACTIVITY', 'L', 'S', 'RATING', 'CONTROL MEASURES']],
            body: riskBody.map(r => r.content),
            theme: 'grid',
            headStyles: { fillColor: primaryColor, textColor: 255, fontStyle: 'bold' },
            columnStyles: { 
                0: { width: 50, fontSize: 9 }, 1: { width: 10, halign:'center' }, 2: { width: 10, halign:'center' }, 
                3: { width: 22, halign: 'center', fontStyle:'bold' }, 4: { width: 'auto', fontSize: 9 }
            },
            didParseCell: function(data) {
                if (data.section === 'body' && data.column.index === 3) {
                    const score = riskBody[data.row.index].rawScore;
                    // Colors: Pastel Green / Yellow / Red
                    if (score >= 6) data.cell.styles.fillColor = [255, 205, 210]; 
                    else if (score >= 3) data.cell.styles.fillColor = [255, 249, 196]; 
                    else data.cell.styles.fillColor = [220, 237, 200]; 
                }
            }
        });

        // FOOTER & SIGNATURE
        let finalY = doc.lastAutoTable.finalY + 10;
        if (finalY > 200) { doc.addPage(); finalY = 20; }

        if(document.getElementById('coshhCheck').checked) {
            doc.setFontSize(9); doc.setTextColor(0, 100, 0); doc.setFont(undefined, 'bold');
            doc.text("â˜‘ COSHH COMPLIANCE: SDS available for all chemical agents used.", 14, finalY);
            finalY += 10;
        }

        doc.setFontSize(10); doc.setTextColor(0); doc.text("Risk Matrix Key:", 14, finalY);
        doc.autoTable({
            startY: finalY + 2,
            head: [['Score', 'Risk', 'Action']],
            body: [['1-2', 'LOW', 'Monitor'], ['3-4', 'MED', 'Mitigate'], ['6-9', 'HIGH', 'Stop Work']],
            theme: 'grid', headStyles: { fillColor: [80, 80, 80] }, styles: { fontSize: 8 }
        });

        finalY = doc.lastAutoTable.finalY + 20;

        // INSERT SIGNATURE IMAGE
        const sigData = canvas.toDataURL('image/png');
        // Only add signature if user has drawn something (crude check via canvas data size or just always add)
        doc.addImage(sigData, 'PNG', 14, finalY - 15, 50, 25); // x, y, width, height
        
        doc.setDrawColor(0); doc.line(14, finalY + 10, 80, finalY + 10);
        doc.text(`Assessor: ${document.getElementById('assessorName').value}`, 14, finalY + 15);
        doc.text("Signature", 14, finalY + 20);
        
        doc.save(`RAMS_${document.getElementById('projectRef').value}.pdf`);
    }
</script>

</body>
</html>
